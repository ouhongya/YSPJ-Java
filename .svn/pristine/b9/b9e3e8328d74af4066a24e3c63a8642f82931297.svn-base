<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="StatisticsMapper">
    <select id="queryUnitList" parameterType="java.lang.String" resultType="pd">
        select sys_unit.UNIT_ID as id, sys_unit.NAME as name
        from tb_task
                     left join sys_unit on tb_task.unit_id = sys_unit.UNIT_ID
        where tb_task.id = #{id}
    </select>

    <select id="queryTaskDetailList" parameterType="java.util.List" resultType="pd">
        select norm_detail_id, check_item, to_check
        from tb_task_detail where 1 = 1
        <if test="list != null and list.size() > 0">
            and task_id
            <foreach collection="list" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by norm_detail_id
    </select>

    <select id="queryExcelByNormDetail" parameterType="java.util.List" resultType="java.lang.String">
        select tb_norm_detail.id
        from tb_norm
                     left join tb_norm_detail on tb_norm.id = tb_norm_detail.norm_id where
                tb_norm.excel_id
        <foreach collection="list" item="item" open="in(" separator="," close=")">
            #{item}
        </foreach>
        group by tb_norm_detail.id
    </select>
    <select id="queryExcelNum" parameterType="java.util.List" resultType="java.lang.Integer">
        select sum(tb_excel.total_censor) as total_censor
        from tb_excel where id
        <foreach collection="list" item="item" open="in(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="queryTaskSchedule" parameterType="com.fh.entity.app.Statistics" resultType="java.lang.String">
        select * from (
                select task.id
                from (select *
                from (select *
                      from tb_task where 1 = 1
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task where 1 = 1
                 and task.type = 1
                 and task.STATUS != 2 and task.STATUS != 12


        <if test="taskId != null and taskId.size() > 0">

            and task.id


            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>

        <if test="userId != null and userId.size() > 0">
            or task.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
            or task.group_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by task.id
                ) task
                inner join (select *
                            from tb_task_excel where 1 = 1
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) excel ON task.id = excel.task_id
                ) task
    </select>

    <select id="queryTaskSchedule1" parameterType="com.fh.entity.app.Statistics" resultType="java.lang.String">
        select * from (
                select task.id
                from (select *
                from (select *
                      from tb_task where 1 = 1
                                     and tb_task.type = 1
                                     and tb_task.STATUS != 2
                                     and tb_task.STATUS != 12

        <if test="unitId != null and unitId.size() > 0">

            and tb_task.unit_id

            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task  where 1 =1
        <if test="taskId != null and taskId.size() > 0">
            and task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        or task.user_id = #{uid}
                or task.group_id = #{uid}
                group by task.id
                ) task
                inner join (select *
                            from tb_task_excel where 1 = 1
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) excel ON task.id = excel.task_id
                ) task
                left join tb_task_detail on task.id = tb_task_detail.task_id
                left join (select *
                           from tb_task_censor
                where 1 = 1
                  and tb_task_censor.user_id
        <foreach collection="userId" item="item" open="in(" separator="," close=")">
            #{item}
        </foreach>
        ) task_censor on tb_task_detail.censor_id = task_censor.id
                GROUP BY tb_task_detail.id
    </select>

    <select id="queryTaskSchedule11" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        select * from (
        select task.id
        from (select *
        from (select *
        from tb_task where 1 = 1
        and tb_task.type = 1
        and tb_task.STATUS != 2
        and tb_task.STATUS != 12

        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task where 1 =1
        <if test="taskId != null and taskId.size() > 0">
            and task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        or task.user_id = #{uid}
        group by task.id
        ) task
        inner join (select *
        from tb_task_excel where 1 = 1
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) excel ON task.id = excel.task_id
        ) task
        left join tb_task_detail on task.id = tb_task_detail.task_id
        left join (select *
        from tb_task_censor
        where 1 = 1
        and tb_task_censor.user_id
        <foreach collection="userId" item="item" open="in(" separator="," close=")">
            #{item}
        </foreach>
        ) task_censor on tb_task_detail.censor_id = task_censor.id
        GROUP BY tb_task_detail.id
    </select>

    <select id="queryTaskSchedule2" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        select ifnull(sum(tb_task_censor.general_inspection), 0) as total_censor,
               ifnull(sum(tb_task_censor.checked), 0)            as censor
        from tb_task
                     left join tb_task_detail on tb_task.id = tb_task_detail.task_id
                     left join tb_task_censor on tb_task_detail.censor_id = tb_task_censor.id
        where tb_task.type = 1
          and tb_task.STATUS != 2
          and tb_task.STATUS != 12
          and tb_task_censor.user_id = #{uid}
    </select>

    <select id="queryTaskToSiteList" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        SELECT ss.unit_id, ss.id, sys_unit.NAME as name FROM (
                select task.* from (
                select task.*
                from (select *
                      from tb_task where 1 = 1
                                     and tb_task.type = 1
                                     and tb_task.STATUS != 2
                                     and tb_task.STATUS != 12
                                     and tb_task.total_issue != 0

        <if test="unitId != null and unitId.size() > 0">

            and tb_task.unit_id

            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="taskId != null and taskId.size() > 0">
            and tb_task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="userId != null and userId.size() > 0">
            or tb_task.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task
                inner join tb_task_excel ON task.id = tb_task_excel.task_id
                where 1 = 1
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by task.id
                )
                task
                GROUP BY task.id
                ) ss
                left join sys_unit on ss.unit_id = sys_unit.UNIT_ID
    </select>

    <select id="queryTaskName" parameterType="java.lang.String" resultType="String">
        select tb_task.name
        from tb_task
        where id = #{id}
    </select>


    <select id="queryTaskToSiteList1" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        SELECT ss.unit_id, ss.id, ss.name as name FROM (
                select task.* from (
                select task.*
                from (select *
                      from tb_task where 1 = 1
                                     and tb_task.type = 1
                                     and tb_task.STATUS != 2
        and tb_task.STATUS != 12
        and tb_task.total_issue != 0

        <if test="unitId != null and unitId.size() > 0">

            and tb_task.unit_id

            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="taskId != null and taskId.size() > 0">
            and tb_task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        or tb_task.user_id = #{uid}
                ) task
                inner join tb_task_excel ON task.id = tb_task_excel.task_id
                where 1 = 1
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by task.id
                )task
                left join tb_task_detail on task.id = tb_task_detail.task_id
                left join tb_task_censor on
                tb_task_detail.censor_id = tb_task_censor.id where 1 = 1
                                                               and tb_task_censor.status!=9

        <if test="userId != null and userId.size() > 0">

            or tb_task_censor.user_id

            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by task.id
                ) ss
                left join sys_unit on ss.unit_id = sys_unit.UNIT_ID
    </select>

    <select id="queryTaskByUnit" parameterType="java.lang.String" resultType="java.lang.String">
        select unit_id
        from tb_task
        where id = #{id}
    </select>

    <select id="queryTaskToSiteList2" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        SELECT ss.unit_id, ss.id, ss.name as name
        FROM (
                     select task.*
                     from (
                                  select task.*
                                  from (select * from tb_task where 1 = 1) task
                                               inner join tb_task_excel ON task.id = tb_task_excel.task_id
                                  where 1 = 1
                                    and task.type = 1
                                    and task.STATUS != 2
                                    and task.STATUS != 12
                                    and task.total_issue != 0
                                  group by task.id
                                  ) task
                                  left join tb_task_detail on task.id = tb_task_detail.task_id
                                  left join tb_task_censor on
                             tb_task_detail.censor_id = tb_task_censor.id
                     where 1 = 1
                       and tb_task_censor.user_id = #{uid}
                     group by task.id
                     ) ss
                     left join sys_unit on ss.unit_id = sys_unit.UNIT_ID
    </select>

    <select id="queryTaskIssueList" parameterType="java.util.List" resultType="pd">
        select ifnull(sum(total_issue), 0) as total_issue, ifnull(sum(total_score), 0) - ifnull(sum(score), 0) as score
        from tb_task where 1 = 1
                       and tb_task.id
        <foreach collection="list" item="item" open="in(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="queryTaskIssueList1" parameterType="com.fh.entity.app.TaskMybatis" resultType="pd">
        select ifnull(sum(tb_task_censor.total_issue), 0)                                        as total_issue,
               ifnull(sum(tb_task_censor.total_score), 0) - ifnull(sum(tb_task_censor.score), 0) as score
        from tb_task
                     left join tb_task_detail on tb_task.id = tb_task_detail.task_id
                     left join tb_task_censor on tb_task_detail.censor_id = tb_task_censor.id  where 1 = 1
                                                                                                 and tb_task_censor.user_id = #{userId}
                                                                                                 and tb_task.id
        <foreach collection="taskId" item="item" open="in(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="queryTaskSiteList" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        SELECT ss.unit_id, sys_unit.NAME as name FROM (
                select task.* from (
                select *
                from tb_task
                             left join tb_task_excel ON tb_task.id = tb_task_excel.task_id
                where 1 = 1
                  and task.type = 1
                  and task.STATUS != 2 and task.STATUS != 12


        <if test="taskId != null and taskId.size() > 0">

            and tb_task.id


            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="userId != null and userId.size() > 0">
            or tb_task.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
            or tb_task.group_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by tb_task.id
                )
                task
                GROUP BY task.id
                ) ss
                left join sys_unit on ss.unit_id = sys_unit.UNIT_ID
    </select>

    <select id="queryTaskSiteList1" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        SELECT ss.unit_id, sys_unit.NAME as name FROM (
                select task.* from (
                select *
                from tb_task
                             left join tb_task_excel ON tb_task.id = tb_task_excel.task_id where tb_task.STATUS = 10
                and tb_task.type = 1
        <if test="taskId != null and taskId.size() > 0">
            and tb_task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        or tb_task.user_id = #{uid}
        or tb_task.group_id = #{uid}
                group by tb_task.id
                )
                task
                left join tb_task_detail on task.id = tb_task_detail.task_id
                left join tb_task_censor on tb_task_detail.censor_id = tb_task_censor.id
                GROUP BY task.id
                ) ss
                left join sys_unit on ss.unit_id = sys_unit.UNIT_ID
    </select>

    <select id="queryTaskSiteList2" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        SELECT ss.unit_id, sys_unit.NAME as name FROM (
                select task.* from (
                select *
                from tb_task
                             left join tb_task_excel ON tb_task.id = tb_task_excel.task_id where tb_task.STATUS = 10
                                                                                             and tb_task.type = 1
        <if test="taskId != null and taskId.size() > 0">
            and tb_task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by tb_task.id
                )
                task
                left join tb_task_detail on task.id = tb_task_detail.task_id
                left join tb_task_censor on tb_task_detail.censor_id = tb_task_censor.id
                where tb_task_censor.user_id = #{uid}
                GROUP BY task.id
                ) ss
                left join sys_unit on ss.unit_id = sys_unit.UNIT_ID
    </select>

    <select id="queryTaskSiteToIssueList" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        SELECT SUM(ss.total_issue)                                       AS totalIssue,
               SUM(IFNULL(ss.total_score, 0)) - SUM(IFNULL(ss.score, 0)) AS totalScore FROM (
                select task.* from (
                select tb_task.*
                from tb_task
                             left join tb_task_excel ON tb_task.id = tb_task_excel.task_id where tb_task.unit_id = #{siteId}
                                                                                             and tb_task.type = 1
        <if test="taskId != null and taskId.size() > 0">
            and tb_task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by tb_task.id
                ) task
                left join tb_task_detail on task.id = tb_task_detail.task_id
                left join tb_task_censor on tb_task_detail.censor_id = tb_task_censor.id
        <if test="userId != null and userId.size() > 0">
            where tb_task_censor.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
            or task.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
            or task.group_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        GROUP BY task.id
                ) ss
                left join sys_unit on ss.site_id = sys_unit.UNIT_ID
    </select>

    <select id="queryTaskSiteToIssueList1" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        SELECT SUM(ss.total_issue)                                       AS totalIssue,
               SUM(IFNULL(ss.total_score, 0)) - SUM(IFNULL(ss.score, 0)) AS totalScore
                FROM (
                SELECT tb_task_censor.total_issue,
                       tb_task_censor.total_score,
                       tb_task_censor.score,
                       task.id,
                       task.site_id
                FROM (
                SELECT tb_task.*
                FROM tb_task
                             LEFT JOIN tb_task_excel
                        ON tb_task.id = tb_task_excel.task_id
                WHERE tb_task.unit_id = #{siteId}
                and tb_task.type = 1
        <if test="taskId != null and taskId.size() > 0">
            and tb_task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        or tb_task.user_id = #{uid}
        or tb_task.group_id = #{uid}
                group by tb_task.id
                ) task
                left join tb_task_detail on task.id = tb_task_detail.task_id
                left join tb_task_censor on tb_task_detail.censor_id = tb_task_censor.id
                GROUP BY tb_task_censor.id ) ss
                LEFT JOIN sys_unit
                ON ss.site_id = sys_unit.UNIT_ID;
    </select>

    <select id="queryTaskSiteToIssueList2" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        SELECT SUM(ss.total_issue)                                       AS totalIssue,
               SUM(IFNULL(ss.total_score, 0)) - SUM(IFNULL(ss.score, 0)) AS totalScore FROM (
                select task.* from (
                select tb_task.*
                from tb_task
                             left join tb_task_excel ON tb_task.id = tb_task_excel.task_id where tb_task.unit_id = #{siteId}
                                                                                             and tb_task.type = 1
        <if test="taskId != null and taskId.size() > 0">
            and tb_task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by tb_task.id
                ) task
                left join tb_task_detail on task.id = tb_task_detail.task_id
                left join tb_task_censor on tb_task_detail.censor_id = tb_task_censor.id
                where tb_task_censor.user_id = #{uid}
                GROUP BY task.id
                ) ss
                left join sys_unit on ss.site_id = sys_unit.UNIT_ID
    </select>

    <select id="issueModuleIds" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        select task_detail.totalIssue, task_detail.totalScore, tb_norm_detail.item from (
                select tb_task_detail.id,
                       sum(tb_task_detail.total_issue)                                                   as totalIssue,
                       IFNULL(sum(tb_task_detail.total_score), 0) - IFNULL(sum(tb_task_detail.score), 0) as totalScore,
                       tb_task_detail.norm_detail_id                                                     as task_detail_id
                from (
                select task.*
                from (select *
                      from tb_task where tb_task.type = 1 and id
        <if test="taskId != null and taskId.size() > 0">
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id

            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="userId != null and userId.size() > 0">
            or tb_task.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
            or tb_task.group_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        )task
                left join tb_task_excel ON task.id = tb_task_excel.task_id where 1 = 1

        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by task.id
                ) task
                left join tb_task_detail on task.id = tb_task_detail.task_id and tb_task_detail.total_issue!=0
        left join tb_task_censor
                on tb_task_detail.censor_id = tb_task_censor.id
                where tb_task_detail.total_issue != 0
        <if test="userId != null and userId.size() > 0">
            and tb_task_censor.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        GROUP BY tb_task_detail.id
                ) task_detail
                left join tb_norm_detail
                on task_detail.task_detail_id = tb_norm_detail.id
                group by tb_norm_detail.id
    </select>

    <select id="issueCountIds" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        select task_detail.norm_detail_id as id, task_detail.rowId
                from (
                select task.*
                from (select *
                      from tb_task where 1 = 1
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        )task
                left join tb_task_excel ON task.id = tb_task_excel.task_id
                where 1 = 1
                  and task.type = 1
                  and task.STATUS != 2 and task.STATUS != 12

        <if test="taskId != null and taskId.size() > 0">

            and task.id

            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="userId != null and userId.size() > 0">
            and task.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by task.id
                ) task
                left join (
                select tb_task_detail.task_id, tb_task_row.norm_detail_id, tb_task_row.id as rowId
                from tb_task_censor
                             left join tb_task_detail on tb_task_censor.id = tb_task_detail.censor_id
                             left join tb_task_row on tb_task_detail.id = tb_task_row.detail_id
                where tb_task_row.issue != 0
                group by tb_task_row.id
                ) task_detail on task.id = task_detail.task_id
                where task_detail.rowId is not null
    </select>

    <select id="issueCountIds11" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        select task_detail.norm_detail_id as id,
               task_detail.rowId
                from   (select task.*
                from     (select *
                          from tb_task
                where 1 = 1
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task
                left join tb_task_excel
                on task.id = tb_task_excel.task_id
                where 1 = 1
                  and task.type = 1
                  and task.STATUS != 2
        and task.STATUS != 12

        <if test="taskId != null and taskId.size() > 0">

            and task.id

            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by task.id) task
                left join (select tb_task_detail.task_id,
                                  tb_task_row.norm_detail_id,
                                  tb_task_row.id as rowId
                from     (select *
                          from tb_task_censor
                where 1 = 1
        <if test="userId != null and userId.size() > 0">
            and tb_task_censor.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        and 1 = 1) censor
                left join tb_task_detail
                on censor.id = tb_task_detail.censor_id
                left join tb_task_row
                on tb_task_detail.id = tb_task_row.detail_id
                where tb_task_row.issue != 0
                group by tb_task_row.id) task_detail
                on task.id = task_detail.task_id
                where task_detail.rowId is not null
        <!--        select task_detail.norm_detail_id as id, task_detail.rowId-->
        <!--        from (-->
        <!--        select task.*-->
        <!--        from (select *-->
        <!--        from tb_task where 1 = 1-->
        <!--        <if test="unitId != null and unitId.size() > 0">-->
        <!--            and tb_task.unit_id-->
        <!--            <foreach collection="unitId" item="item" open="in(" separator="," close=")">-->
        <!--                #{item}-->
        <!--            </foreach>-->
        <!--        </if>-->
        <!--        )task-->
        <!--        left join tb_task_excel ON task.id = tb_task_excel.task_id-->
        <!--        where 1 = 1-->
        <!--        and task.type = 1-->
        <!--        and task.STATUS != 2 and task.STATUS != 12-->
        <!--        <if test="taskId != null and taskId.size() > 0">-->
        <!--            and task.id-->
        <!--            <foreach collection="taskId" item="item" open="in(" separator="," close=")">-->
        <!--                #{item}-->
        <!--            </foreach>-->
        <!--        </if>-->
        <!--        <if test="excelId != null and excelId.size() > 0">-->
        <!--            and tb_task_excel.excel_id-->
        <!--            <foreach collection="excelId" item="item" open="in(" separator="," close=")">-->
        <!--                #{item}-->
        <!--            </foreach>-->
        <!--        </if>-->
        <!--        group by task.id-->
        <!--        ) task-->
        <!--        left join (-->
        <!--        select tb_task_detail.task_id, tb_task_row.norm_detail_id, tb_task_row.id as rowId-->
        <!--        from (select *-->
        <!--        from tb_task_censor where 1 = 1-->
        <!--        <if test="userId != null and userId.size() > 0">-->
        <!--            and tb_task_censor.user_id-->
        <!--            <foreach collection="userId" item="item" open="in(" separator="," close=")">-->
        <!--                #{item}-->
        <!--            </foreach>-->
        <!--        </if>-->
        <!--        ) censor-->
        <!--        left join tb_task_detail on censor.id = tb_task_detail.censor_id-->
        <!--        left join tb_task_row on tb_task_detail.id = tb_task_row.detail_id-->
        <!--        where tb_task_row.issue != 0-->
        <!--        group by tb_task_row.id-->
        <!--        ) task_detail on task.id = task_detail.task_id-->
        <!--        where task_detail.rowId is not null-->
    </select>

    <select id="issueCountIds22" parameterType="pd" resultType="pd">
        select task_detail.norm_detail_id as id, task_detail.rowId
        from (
                     select tb_task.*
                     from tb_task
                     where 1 = 1
                       and tb_task.type = 1
                       and tb_task.STATUS != 2 and tb_task.STATUS != 12
                     ) task
                     left join (
                select tb_task_detail.task_id, tb_task_row.norm_detail_id, tb_task_row.id as rowId
                from (select *
                      from tb_task_censor
                      where 1 = 1
                        and tb_task_censor.user_id = #{uid}
                        and tb_task_censor.status!=9) censor
                             left join tb_task_detail on censor.id = tb_task_detail.censor_id
                             left join tb_task_row on tb_task_detail.id = tb_task_row.detail_id
                where tb_task_row.issue > 0
                group by tb_task_row.id
                ) task_detail on task.id = task_detail.task_id
        where task_detail.rowId is not null
    </select>

    <select id="queryDetailSerial" parameterType="java.lang.String" resultType="String">
        select serial
        from tb_norm_detail
        where id = #{rowId}
    </select>

    <select id="queryDetailName" parameterType="java.lang.String" resultType="String">
        select item
        from tb_norm_detail
        where id = #{id}
    </select>

    <select id="issueCountIds1" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        select task_detail.norm_detail_id as id, task_detail.rowId
                from (
                select tb_task.*
                from tb_task
                             left join tb_task_excel ON tb_task.id = tb_task_excel.task_id where 1 = 1
                and tb_task.type = 1
        <if test="taskId != null and taskId.size() > 0">
            and tb_task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        or tb_task.user_id = #{uid}
        or tb_task.group_id = #{uid}
                group by tb_task.id
                ) task
                left join (
                select tb_task_detail.task_id, tb_task_row.norm_detail_id, tb_task_row.id as rowId
                from tb_task_censor
                             left join tb_task_detail on tb_task_censor.id = tb_task_detail.censor_id
                             left join tb_task_row on tb_task_detail.id = tb_task_row.detail_id
                ) task_detail on task.id = task_detail.task_id
    </select>

    <select id="issueCountIds2" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        select task_detail.norm_detail_id as id, task_detail.rowId
                from (
                select tb_task.*
                from tb_task
                             left join tb_task_excel ON tb_task.id = tb_task_excel.task_id where 1 = 1
                                                                                             and tb_task.type = 1
        <if test="taskId != null and taskId.size() > 0">
            and tb_task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by tb_task.id
                ) task
                left join (
                select tb_task_detail.task_id, tb_task_row.norm_detail_id, tb_task_row.id as rowId
                from tb_task_censor
                             left join tb_task_detail on tb_task_censor.id = tb_task_detail.censor_id
                             left join tb_task_row on tb_task_detail.id = tb_task_row.detail_id
                        and tb_task_censor.user_id = #{uid}
                ) task_detail on task.id = task_detail.task_id
    </select>

    <select id="queryNormDetailName" parameterType="java.lang.String" resultType="java.lang.String">
        select tb_norm_detail.item
        from tb_norm_detail
        where tb_norm_detail.id = #{id}
    </select>

    <select id="queryTaskOverDetail" parameterType="com.fh.entity.app.Statistics" resultType="pd" useCache="false">
        select task.user_id,
               task.type,
               task.name         as unitName,
               task.STATUS       as status,
               task.total_censor as total_censor,
               task.censor       as censor,
               task.total_issue  as total_issue
                from (
                select task2.*, sys_unit.NAME as name from (
                select id,
                       task1.unit_id,
                       task1.type,
                       task1.user_id,
                       task1.STATUS,
                       task1.total_censor,
                       task1.censor,
                       task1.total_issue
                from (select *
                from (select *
                      from tb_task where 1 = 1
                                     and tb_task.type = 1
                                     and tb_task.STATUS != 2 and tb_task.STATUS != 12

        <if test="unitId != null and unitId.size() > 0">

            and tb_task.unit_id

            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task where 1 = 1
        <if test="taskId != null and taskId.size > 0">
            and task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="userId != null and userId.size() > 0">
            and task.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task1
                ) task2
                left join sys_unit on task2.unit_id = sys_unit.UNIT_ID
                inner join (select *
                            from tb_task_excel
        <if test="excelId != null and excelId.size() > 0">
            where tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        )task_excel ON task2.id = task_excel.task_id
                ) task
                where task.user_id is not null
    </select>

    <select id="queryTaskOverDetail1" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        select task_censor.user_id,
               task.type,
               task.name                      as unitName,
               task_censor.STATUS             as status,
               task_censor.general_inspection as total_censor,
               task_censor.checked            as censor,
               task_censor.total_issue        as total_issue
                from (
                select id, task1.unit_id, task1.name, task1.type
                from (select *
                from (select *
                      from tb_task where 1 = 1
                                     and tb_task.type = 1
                                     and tb_task.STATUS != 2 and tb_task.STATUS != 12

        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task where 1 = 1
        <if test="taskId != null and taskId.size > 0">
            and task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        or task.user_id = #{uid}
        or task.group_id = #{uid}
                ) task1
                inner join (select *
                            from tb_task_excel
        <if test="excelId != null and excelId.size() > 0">
            where tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        )task_excel ON task1.id = task_excel.task_id
                ) task
                left join tb_task_detail on task.id = tb_task_detail.task_id
                left join (select *
                           from tb_task_censor
        <if test="userId != null and userId.size() > 0">
            where tb_task_censor.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task_censor on tb_task_detail.censor_id = task_censor.id
                where task_censor.user_id is not null
                group by task_censor.id
    </select>

    <select id="queryTaskOverDetail2" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        select task_censor.user_id,
               task.type,
               task.name                      as unitName,
               task_censor.STATUS             as status,
               task_censor.general_inspection as total_censor,
               task_censor.checked            as censor,
               task_censor.total_issue        as total_issue
                from (
                select id, task1.unit_id, task1.name, task1.type
                from (select *
                from (select *
                      from tb_task where 1 = 1
                                     and tb_task.type = 1
                                     and tb_task.STATUS != 2 and tb_task.STATUS != 12

        <if test="unitId != null and unitId.size() > 0">

            and tb_task.unit_id

            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task where 1 = 1
        <if test="taskId != null and taskId.size > 0">
            and task.id
            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        or task.user_id = #{uid}
        or task.group_id = #{uid}
                ) task1
                inner join (select *
                            from tb_task_excel
        <if test="excelId != null and excelId.size() > 0">
            where tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        )task_excel ON task1.id = task_excel.task_id
                ) task
                left join tb_task_detail on task.id = tb_task_detail.task_id
                left join (select *
                           from tb_task_censor
        <if test="userId != null and userId.size() > 0">
            where tb_task_censor.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) task_censor on tb_task_detail.censor_id = task_censor.id
                where task_censor.user_id is not null
                group by task_censor.id
    </select>

    <select id="queryWorkload" parameterType="com.fh.entity.app.Statistics" resultType="pd">
        select task.user_id,
               sum(task.censor)      as checked,
               sum(task.total_issue) as total_issue,
               sum(task.solved_issue)   solved_issue from (
                select tb_task.*
                from tb_task
                             left join tb_task_excel ON tb_task.id = tb_task_excel.task_id
                where 1 = 1
                  and tb_task.type = 1
                  and tb_task.STATUS != 2 and tb_task.STATUS != 12

        <if test="taskId != null and taskId.size() > 0">

            and tb_task.id

            <foreach collection="taskId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="userId != null and userId.size() > 0">
            and tb_task.user_id
            <foreach collection="userId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="unitId != null and unitId.size() > 0">
            and tb_task.unit_id
            <foreach collection="unitId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="excelId != null and excelId.size() > 0">
            and tb_task_excel.excel_id
            <foreach collection="excelId" item="item" open="in(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        group by tb_task.id
                ) task
    </select>

    <select id="queryUserName" parameterType="java.lang.String" resultType="java.lang.String">
        select sys_user.name
        from sys_user
        where USER_ID = #{id}
    </select>

    <select id="queryUserByRole" parameterType="pd" resultType="java.lang.Integer">
        select tb_function.FUNCTION_ID
        from sys_user
                     left join sys_role on sys_user.ROLE_ID = sys_role.ROLE_ID
                     left join tb_function on sys_role.FUNCTION_ID = tb_function.FUNCTION_ID
        where sys_user.USER_ID = #{uid}
        group by sys_user.USER_ID
    </select>


    <select id="queryUnitName" parameterType="java.lang.String" resultType="java.lang.String">
        select sys_unit.NAME
        from sys_unit
        where UNIT_ID = #{id}
    </select>
</mapper>